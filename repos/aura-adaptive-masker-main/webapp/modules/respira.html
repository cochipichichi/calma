<!doctype html><html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Respira+ â€” CALMA</title>
<style>body{margin:0;display:grid;place-items:center;height:100vh;background:#0b1224;color:#e8f0ff;font-family:system-ui}canvas{width:min(380px,80vw);height:min(380px,80vw)}</style>
  <link rel="stylesheet" href="assets/css/accessibility.css">
  <link rel="stylesheet" href="assets/css/dock.css">
</head><body>
<main><h1>Respira+ ğŸ«</h1><canvas id="breath" width="600" height="600"></canvas></main>
<script>
(function(){
  const c = document.getElementById('breath'); const ctx = c.getContext('2d');
  let w,h,animId=null; function resize(){ w=c.width=c.clientWidth*2; h=c.height=c.clientHeight*2; }
  let pattern={ inhale:4, hold:0, exhale:6 };
  function draw(ts){
    ctx.clearRect(0,0,w,h); const cx=w/2, cy=h/2;
    const total=pattern.inhale+pattern.hold+pattern.exhale;
    const t=(ts/1000)%total; let phase,p;
    if(t<pattern.inhale){ phase='in'; p=t/pattern.inhale; }
    else if(t<pattern.inhale+pattern.hold){ phase='hold'; p=(t-pattern.inhale)/Math.max(0.001,pattern.hold); }
    else { phase='out'; p=(t-pattern.inhale-pattern.hold)/pattern.exhale; }
    const rMin=Math.min(w,h)*0.18, rMax=Math.min(w,h)*0.34; let r;
    if(phase==='in'){ const e=(1-Math.cos(Math.PI*p))/2; r=rMin+(rMax-rMin)*e; }
    else if(phase==='hold'){ r=rMax; }
    else { const e=(1-Math.cos(Math.PI*(1-p)))/2; r=rMin+(rMax-rMin)*e; }
    ctx.save(); ctx.shadowBlur=40; ctx.shadowColor='rgba(200,220,255,.55)';
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='rgba(230,240,255,.15)'; ctx.fill(); ctx.restore();
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.lineWidth=Math.min(w,h)*0.02; ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.stroke();
    animId=requestAnimationFrame(draw);
  }
  function start(){ if(!animId) animId=requestAnimationFrame(draw); }
  window.addEventListener('resize', resize); resize(); start();
})();
</script>

<footer class="calma-footer" style="margin-top:2rem;padding:1rem;text-align:center;opacity:.9">bienestar auditivo â€” Hecho con amor por Pancho para mi BelÃ©n ğŸ’œ</footer>

  <script src="assets/js/accessibility.js"></script>
  <script src="assets/js/dock.js"></script>

<div class="controls" style="margin-top:1rem;display:grid;gap:.5rem">
  <div style="display:flex;gap:.5rem;flex-wrap:wrap;align-items:center">
    <label>ğŸ™ï¸ GuÃ­a con tu audio: <input id="voiceFile" type="file" accept="audio/*"></label>
    <button onclick="window.playGuideOnce && window.playGuideOnce()">â–¶ï¸ Probar audio</button>
  </div>
  <details style="background:rgba(255,255,255,.06);padding:.6rem;border-radius:10px">
    <summary>ğŸ¤ Respira juntos (P2P sin servidor)</summary>
    <div style="display:grid;gap:.4rem;margin-top:.5rem">
      <button id="makeOffer">1) Crear oferta</button>
      <textarea id="rtcOffer" rows="3" placeholder="Copiar y enviar a tu pareja"></textarea>
      <button id="acceptOffer">2) Aceptar oferta / Crear respuesta</button>
      <textarea id="rtcAnswer" rows="3" placeholder="Pegar aquÃ­ la respuesta del otro dispositivo"></textarea>
      <button id="sendSync">ğŸ”„ Sincronizar respiraciÃ³n ahora</button>
      <small>Usa mensajerÃ­a para copiar/pegar la oferta y respuesta. No requiere cuentas ni servidor.</small>
    </div>
  </details>
</div>

<script>
// === Respira Juntos (P2P WebRTC por copia/pega) + Audio personalizado ===
(()=>{
  // Audio personalizado
  const file = document.getElementById('voiceFile');
  if(file){
    file.addEventListener('change', ()=>{
      const f = file.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      const audio = new Audio(url); audio.loop = false;
      window.playGuideOnce = () => { audio.currentTime=0; audio.play(); };
    });
  }

  // WebRTC copy/paste (sin servidor)
  const areaOffer = document.getElementById('rtcOffer');
  const areaAnswer= document.getElementById('rtcAnswer');
  const btnMakeOffer = document.getElementById('makeOffer');
  const btnAcceptOffer= document.getElementById('acceptOffer');
  const btnSendSync = document.getElementById('sendSync');

  const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  let ch = pc.createDataChannel('sync');
  ch.onopen = ()=>console.log('canal abierto');
  ch.onmessage = (e)=>{
    if(e.data==='sync-breath' && window.Respira && Respira.setPattern){
      // reinicia animaciÃ³n forzando repaint
      if (window.Respira.restart) window.Respira.restart();
    }
  };

  btnMakeOffer && btnMakeOffer.addEventListener('click', async ()=>{
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    // Espera ICE gather
    await new Promise(res=>{ if(pc.iceGatheringState==='complete') res(); else pc.onicegatheringstatechange=()=> pc.iceGatheringState==='complete' and res(); });
  });
  pc.onicecandidate = ()=>{ if(pc.localDescription){ areaOffer.value = JSON.stringify(pc.localDescription); } };

  btnAcceptOffer && btnAcceptOffer.addEventListener('click', async ()=>{
    try{
      const desc = JSON.parse(areaOffer.value);
      await pc.setRemoteDescription(desc);
      const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
    }catch(e){ alert('Oferta invÃ¡lida'); }
  });
  pc.oniceconnectionstatechange = ()=>{
    if(pc.iceConnectionState==='connected'){
      console.log('P2P conectado');
    }
  };
  pc.ondatachannel = (ev)=>{ ch = ev.channel; ch.onmessage = (e)=>{ if(e.data==='sync-breath' && window.Respira && Respira.restart) Respira.restart(); }; };

  btnSendSync && btnSendSync.addEventListener('click', ()=>{ try{ ch && ch.send('sync-breath'); }catch(e){} });

  // Pegar answer
  areaAnswer && areaAnswer.addEventListener('change', async ()=>{
    try{
      const ans = JSON.parse(areaAnswer.value);
      await pc.setRemoteDescription(ans);
    }catch(e){}
  });
})();
</script>

</body></html>